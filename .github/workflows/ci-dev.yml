name: CI - Dev Branch

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install dvc gcsfs

    - name: Configure GCP Credentials
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    - name: Configure DVC
      run: |
        dvc init --no-scm
        dvc remote add -d myremote gs://mlops-iris-week2-graded-unique-shubhamg/week_2
        dvc pull

    - name: Run tests with pytest
      run: |
        pytest tests/ -v --tb=short

    - name: Setup CML
      uses: iterative/setup-cml@v2

    - name: Generate CML report
      env:
        REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "# IRIS Pipeline Test Results" > report.md
        echo "" >> report.md
        echo "## Model Performance" >> report.md

        # Create and run Python script for model metrics
        python -c "
        import joblib
        import pandas as pd
        from sklearn.metrics import accuracy_score, classification_report, confusion_matrix
        
        # Load model and data
        model = joblib.load('model.joblib')
        data = pd.read_csv('data/data.csv')
        
        # Prepare features and target
        X = data.drop('species', axis=1)
        y = data['species']
        
        # Make predictions
        predictions = model.predict(X)
        accuracy = accuracy_score(y, predictions)
        
        print(f'**Accuracy:** {accuracy:.3f}')
        print('')
        print('**Confusion Matrix:**')
        print('\`\`\`')
        cm = confusion_matrix(y, predictions)
        print('Actual \\\\ Predicted  setosa  versicolor  virginica')
        species = ['setosa', 'versicolor', 'virginica']
        for i, actual in enumerate(species):
            print(f'{actual:12}      {cm[i]}')
        print('\`\`\`')
        " >> report.md

        echo "" >> report.md
        echo "## Test Results Summary" >> report.md
        echo "- **Total Tests:** 4" >> report.md  
        echo "- **Passed:** 4" >> report.md
        echo "- **Failed:** 0" >> report.md
        echo "- **Errors:** 0" >> report.md
        echo "" >> report.md
        echo "**MLOps Pipeline: âœ… HEALTHY**" >> report.md

        # Post report as comment
        cml comment create report.md